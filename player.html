<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/index.css">
    <link rel="icon" href="img/logo.jpg" />
    <title>GarageB - O Site Oficial da Banda</title>
</head>

<body id="conectar_pag">

    <header>
        <div id="cabecalho">
            <div class="logo"></div>
            <nav class="menu-site menu-desktop">
                <a href="conectar.html">Voltar</a>
                <a href="index.html">Home</a>
            </nav>

            <button class="menu-hamburguer" aria-label="Abrir Menu">&#9776;</button>

            <nav class="menu-mobile">
                <a href="conectar.html">Voltar</a>
                <a href="index.html">Home</a>
            </nav>

        </div>
    </header>

    <main class="radio-selection-section">

        <h1 class="page-title">Escolha o Seu Canal de Rock</h1>

        <div class="channel-selector">
            <button id="btn-casa" class="btn-channel active" data-channel="casa">üè† R√°dio Casa</button>
            <button id="btn-rua" class="btn-channel" data-channel="rua">üõ£Ô∏è R√°dio Rua</button>
        </div>

        <div class="player-container">
            <h2 id="channel-title">R√°dio Casa: Classic Rock</h2>
            <p id="channel-description">O melhor do Classic Rock, Blues e Folk. M√∫sica para relaxar.</p>

            <audio id="audio-player" controls preload="none">
                Seu navegador n√£o suporta o elemento de √°udio.
            </audio>

            <div class="stream-info">
                <p>Status: <span id="status-message">Carregando...</span></p>
                <p>Streaming: <span id="stream-url"></span></p>
            </div>
        </div>

    </main>

    <footer>
        <p id="texto_rodape">&copy; 2025 GarageB. Todos os direitos reservados.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const menuHamburguer = document.querySelector('.menu-hamburguer');
            const menuMobile = document.querySelector('.menu-mobile');
            menuHamburguer.addEventListener('click', () => { menuMobile.classList.toggle('active'); });
            document.querySelectorAll('.menu-mobile a').forEach(link => {
                link.addEventListener('click', () => { menuMobile.classList.remove('active'); });
            });
        });
    </script>
    
    <script src="/socket.io/socket.io.js"></script> 

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const socket = io(); 

            // Elementos DOM
            const audioPlayer = document.getElementById('audio-player');
            const channelTitle = document.getElementById('channel-title');
            const channelDescription = document.getElementById('channel-description');
            const statusMessage = document.getElementById('status-message');
            const streamUrlSpan = document.getElementById('stream-url');
            const channelButtons = document.querySelectorAll('.btn-channel');

            const STREAM_URL = "http://localhost:3000/audio/stream";
            let currentChannel = 'casa'; 

            const radios = {
                casa: { title: "R√°dio Casa: Classic Rock (GarageB Stream)", description: "Stream de √Åudio cont√≠nuo da banda.", stream: STREAM_URL },
                rua: { title: "R√°dio Rua: Hard & Heavy (GarageB Stream)", description: "Stream de √Åudio cont√≠nuo da banda.", stream: STREAM_URL }
            };

            function loadChannel(channelKey) {
                const radio = radios[channelKey];
                
                if (audioPlayer.src !== radio.stream) {
                    audioPlayer.src = radio.stream;
                    audioPlayer.load(); 
                }
                
                channelTitle.textContent = radios[channelKey].title;
                channelDescription.textContent = radios[channelKey].description;
                streamUrlSpan.textContent = radios[channelKey].stream; 

                channelButtons.forEach(btn => btn.classList.remove('active'));
                document.getElementById('btn-' + channelKey).classList.add('active');

                currentChannel = channelKey;
                statusMessage.textContent = 'Carregado. Aguardando comando.';

                audioPlayer.play().catch(error => { console.warn("Play autom√°tico bloqueado."); });
            }

            // --- COMUNICA√á√ÉO SOCKET.IO (RECEBIMENTO) ---

            // 0. Recebe o estado inicial
            socket.on('initial_state', (state) => {
                loadChannel(state.channel);
                audioPlayer.play().catch(error => { statusMessage.textContent = 'Aperte PLAY ou aguarde comando do Admin!'; });
            });

            // 1. Recebe o comando de MUDAN√áA DE M√öSICA
            socket.on('song_changed', (newSong) => {
                const wasPlaying = !audioPlayer.paused;
                
                audioPlayer.src = STREAM_URL; 
                audioPlayer.load();
                
                if(wasPlaying) {
                    // O Play ser√° executado pelo comando remoto logo em seguida (remote_playback_control)
                    statusMessage.textContent = `üé∂ NOVA M√öSICA: ${newSong}! Aguardando Play Remoto.`;
                } else {
                    statusMessage.textContent = `M√∫sica trocada para ${newSong}. Pressione Play.`;
                }
                alert(`O Radialista trocou a m√∫sica para: ${newSong}`);
            });
            
            // 2. Recebe o comando de SINCRONIA FOR√áADA
            socket.on('force_sync', (syncTime) => {
                const wasPaused = audioPlayer.paused;
                
                audioPlayer.currentTime = syncTime; 
                
                if (!wasPaused) { 
                     audioPlayer.play().catch(error => { console.warn("Play ap√≥s sincronia bloqueado."); });
                } else {
                     statusMessage.textContent = 'Sincronia ajustada. Player permanece pausado.';
                }
                
                statusMessage.textContent = `üì° SINCRONIZADO para ${Math.floor(syncTime)}s!`;
                alert(`O Radialista sincronizou o stream.`);
            });
            
            // 3. Recebe o comando de Foco de Canal
            socket.on('new_channel', (channel) => {
                 loadChannel(channel);
                 alert(`Aten√ß√£o: A r√°dio mudou de foco para o canal ${channel.toUpperCase()}`);
            });

            // 4. Recebe o comando de Play/Pause REMOTO (CR√çTICO PARA CELULAR)
            socket.on('remote_playback_control', (action) => {
                if (action === 'play') {
                    audioPlayer.play().catch(error => {
                        console.warn("Play Remoto Bloqueado. Usu√°rio deve clicar.");
                        statusMessage.textContent = '‚ñ∂Ô∏è O Admin iniciou o Play. Clique no Play para ouvir!';
                    });
                } else if (action === 'pause') {
                    audioPlayer.pause();
                    statusMessage.textContent = '‚è∏Ô∏è Pausado pelo Admin.';
                }
            });

            // 5. Recebe o comando de REINICIAR STREAM
            socket.on('stream_restarted', (channel) => {
                if (currentChannel === channel) {
                     audioPlayer.load(); 
                     statusMessage.textContent = 'Recarregado pelo Radialista. Tocando...';
                     audioPlayer.play();
                }
            });

            // --- EVENT LISTENERS NATIVOS ---
            document.getElementById('btn-casa').addEventListener('click', () => loadChannel('casa'));
            document.getElementById('btn-rua').addEventListener('click', () => loadChannel('rua'));

            audioPlayer.addEventListener('play', () => {
                statusMessage.textContent = 'Tocando agora...';
                if (audioPlayer.currentTime < 1) { socket.emit('sync_request', 0); }
            });
            
            audioPlayer.addEventListener('pause', () => statusMessage.textContent = 'Pausado.');
            
            audioPlayer.addEventListener('error', () => {
                statusMessage.textContent = '‚ùå Erro no Stream. Tente dar Play ou pe√ßa ao Admin para Recarregar.';
                statusMessage.style.color = 'red';
            });
            
            audioPlayer.addEventListener('ended', () => {
                audioPlayer.load();
                audioPlayer.play();
                statusMessage.textContent = 'Tocando agora... (Repetindo Stream)';
            });
            
            loadChannel(currentChannel);
        });
    </script>

</body>
</html>